# backend/openapi.yaml
# YAML file defining the OpenAPI specification for the on-chain API, used by Swagger UI at /docs
openapi: 3.0.3
info:
  title: CarbonManager On-Chain API
  version: 1.0.0
servers:
  - url: http://localhost:5001
components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
paths:
  /onchain/emissions/{emission_id}:
    post:
      summary: Create/refresh a pending on-chain job for an emission
      tags: [Blockchain]
      parameters:
        - in: path
          name: emission_id
          required: true
          schema: { type: integer, minimum: 1 }
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }
                  emission_id: { type: integer }
                  status: { type: string, enum: [pending] }
                  payload: { type: object }
        "404":
          description: Emission not found
    get:
      summary: Get on-chain status for an emission
      tags: [Blockchain]
      parameters:
        - in: path
          name: emission_id
          required: true
          schema: { type: integer, minimum: 1 }
      responses:
        "200":
          description: Status record
          content:
            application/json:
              schema:
                type: object
                properties:
                  emission_id: { type: integer }
                  status: { type: string, enum: [pending,submitted,confirmed,failed] }
                  tx_hash: { type: string, nullable: true }
                  payload_json: { type: object }
                  error_msg: { type: string, nullable: true }
        "404":
          description: No on-chain record
  /onchain/callback:
    put:
      summary: Chain-service callback to update status & tx hash
      tags: [Blockchain]
      parameters:
        - in: header
          name: X-Chain-Secret
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              oneOf:
                - type: object
                  properties:
                    emission_id: { type: integer }
                    status: { type: string, enum: [submitted,confirmed,failed] }
                    tx_hash: { type: string, nullable: true }
                    error_msg: { type: string, nullable: true }
                - type: object
                  properties:
                    tx_hash: { type: string }
                    status: { type: string, enum: [submitted,confirmed,failed] }
                    error_msg: { type: string, nullable: true }
      responses:
        "200":
          description: Updated
        "401":
          description: Unauthorized
        "404":
          description: Record not found
  /auth/register:
    post:
      summary: Register a new user
      tags: [Authorization]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                account:
                  type: string
                  example: user@example.com
                password:
                  type: string
                  example: mysecret
                role:
                  type: string
                  example: shop
                user_name:
                  type: string
                  example: Alice
                organization_name:
                  type: string
                  example: Lee's Tea
      responses:
        "201":
          description: User registered successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  status_message:
                    type: string
                  access_token:
                    type: string
                  refresh_token:
                    type: string
                  account:
                    type: string
                  password:
                    type: string
                  user_name:
                    type: string
                  role:
                    type: string
                  current_organization_id:
                    type: integer
        "400":
          description: Missing or invalid input
        "409":
          description: User already exists
          
  /auth/login:
    post:
      summary: Login with account and password
      tags: [Authorization]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                account:
                  type: string
                  example: boss@example.com
                password:
                  type: string
                  example: mysecret
      responses:
        "200":
          description: Login successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  status_message:
                    type: string
                  account:
                    type: string
                  access_token:
                    type: string
                  refresh_token:
                    type: string
                  role:
                    type: string
                  current_organization_id:
                    type: integer
        "400":
          description: Invalid input
        "401":
          description: Invalid credentials
  /auth/me:
    get:
      summary: Get current logged-in user
      tags: [Authorization]
      security:
        - BearerAuth: []
      responses:
        "200":
          description: User profile
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: integer
                  email_account:
                    type: string
                  name:
                    type: string
                  user_type:
                    type: string
                    enum: [shop, customer]
                  organization_id:
                    type: integer
        "401":
          description: Unauthorized
    put:
      summary: Update current logged-in user profile
      tags: [Authorization]
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                organization_name:
                  type: string
                  example: organization_name
                user_type:
                  type: string
                  example: user_type
      responses:
        "200":
          description: User profile updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: integer
                  email_account:
                    type: string
                  name:
                    type: string
                  user_type:
                    type: string
                    enum: [shop, customer]
                  organization_id:
                    type: integer
        "400":
          description: Invalid input
        "401":
          description: Unauthorized
    delete:
      summary: Delete current logged-in user
      tags: [Authorization]
      security:
        - BearerAuth: []
      responses:
        "200":
          description: User deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  status_message:
                    type: string
        "401":
          description: Unauthorized
                
  /product_types:
    get:
      summary: Get all available product types from this organization 
      tags: [Product types]
      security:
        - BearerAuth: []
      responses:
        "200":
          description: List of product types
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    id:
                      type: integer
                    name:
                      type: string
        "500":
          description: Server error
    post:
      summary: Create a new product type
      tags: [Product types]
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                  example: Green Tea 2025
      responses:
        "201":
          description: Product type created successfully
          content:
            application/json:
                  name:
                    type: string
        "400":
          description: Invalid input
        "401":
          description: Unauthorized
        "409":
          description: Product type already exists
  /product_types/{product_type_id}:
      get:
        summary: Get a product type by ID
        tags: [Product types]
        security:
          - BearerAuth: []
        parameters:
          - in: path
            name: product_type_id
            required: true
            schema: { type: integer, minimum: 1 }
        responses:
          "200":
            description: Product type details
            content:
              application/json:
                schema:
                  type: object
                  properties:
                    id:
                      type: integer
                    name:
                      type: string
                    description:
                      type: string
          "404":
            description: Product type not found
      put:
        summary: Update a product type by ID
        tags: [Product types]
        security:
          - BearerAuth: []        
        parameters:
          - in: path
            name: product_type_id
            required: true
            schema: { type: integer, minimum: 1 }
        requestBody:      
          required: true
          content:
            application/json:
              schema:
                type: object
                properties:
                  name:
                    type: string
                    example: Updates Green Tea 2025
        responses:
          "200":
            description: Product type updated successfully
            content:
              application/json:
                schema:
                  type: object
                  properties:
                    id:
                      type: integer     
                    name:
                      type: string
                    description:
                      type: string
          "400":
            description: Invalid input
          "401":
            description: Unauthorized
          "404":
            description: Product type not found
      delete:
        summary: Delete a product type by ID
        tags: [Product types]
        security:
          - BearerAuth: []
        parameters:
          - in: path
            name: product_type_id
            required: true        
            schema: { type: integer, minimum: 1 }
        responses:
          "200":
            description: Product type deleted successfully
            content:
              application/json:
                schema:
                  type: object
                  properties:
                    status message:
                      type: string
                    id:
                      type: integer
                    product type_name:
                      type: string
                    order_id:
                      type: integer
                    name:
                      type: string
                    
          "401":
            description: Unauthorized     
          "404":
            description: Product type not found
  /product_types/{product_type_id}/products:
    get:
      summary: Get all products under a product type
      tags: [Products]
      security:
        - BearerAuth: []
      parameters:
        - name: product_type_id
          in: path
          required: true
          schema: { type: integer, minimum: 1 }
      responses:
        "200":
          description: List of products
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    id:
                      type: integer
                    name:
                      type: string
    post:
      summary: Create a new product under a product type
      tags: [Products]
      security:
        - BearerAuth: []
      parameters:
        - name: product_type_id
          in: path
          required: true
          schema: { type: integer, minimum: 1 }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                  example: Batch #12345
      responses:
        "201":
          description: Product created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: integer
                  name:
                    type: string
        "400":
          description: Invalid input
        "401":
          description: Unauthorized
        "404":
          description: Product type not found
        "409":
          description: Product already exists
  /product_types/{product_type_id}/products/{product_id}:
    get:
      summary: Get a product by ID
      tags: [Products]
      security:
        - BearerAuth: []
      parameters:
        - name: product_type_id
          in: path
          required: true
          schema: { type: integer, minimum: 1 }
        - name: product_id
          in: path
          required: true
          schema: { type: integer, minimum: 1 }     
      responses:
        "200":
          description: Product details
          content:
            application/json:
              schema:   
                type: object
                properties:
                  id:
                    type: integer
                  name:
                    type: string
                  product_type_id:
                    type: integer
        "404":
          description: Product not found
    put:    
      summary: Update a product by ID
      tags: [Products]
      security:
        - BearerAuth: []        
      parameters:
        - name: product_type_id
          in: path
          required: true
          schema: { type: integer, minimum: 1 }
        - name: product_id
          in: path
          required: true
          schema: { type: integer, minimum: 1 }
      requestBody:      
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                  example: Updated Batch #12345
      responses:
        "200":
          description: Product updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: integer     
                  name:
                    type: string
                  product_type_id:
                    type: integer
        "400":
          description: Invalid input
        "401":
          description: Unauthorized
        "404":
          description: Product not found
    delete:
      summary: Delete a product by ID
      tags: [Products]
      security:
        - BearerAuth: []
      parameters:     
        - name: product_type_id  
          in: path
          required: true
          schema: { type: integer, minimum: 1 }  
        - name: product_id
          in: path
          required: true        
          schema: { type: integer, minimum: 1 }
      responses:
        "200":
          description: Product deleted successfully
          content:
            application/json: 
              schema:
                type: object
                properties:
                  message:
                    type: string
        "401":
          description: Unauthorized
        "404":
          description: Product not found 
  /factors:
    get:
      summary: Retrieve emission factors
      description: |
        Returns a list of emission factors. Supports search and filtering.
      tags:
        - Factors
      security:
        - BearerAuth: []
      parameters:
        - in: query
          name: q
          schema:
            type: string
          required: false
          description: Free-text keyword to search factor names, categories, or subcategories.
        - in: query
          name: category
          schema:
            type: string
          required: false
          description: Filter by main category (e.g., 能資源, 包裝資材).
        - in: query
          name: midcategory
          schema:
            type: string
          required: false
          description: Filter by middle category.
        - in: query
          name: subcategory
          schema:
            type: string
          required: false
          description: Filter by subcategory.
        - in: query
          name: unit
          schema:
            type: string
          required: false
          description: Filter by unit type (e.g., 立方公尺(m3), 平方公尺(m2)).
        - in: query
          name: limit
          schema:
            type: integer
            default: 20
          required: false
          description: Number of results to return.
        - in: query
          name: offset
          schema:
            type: integer
            default: 0
          required: false
          description: Number of items to skip before starting to return results.
      responses:
        "200":
          description: Successful operation
          content:
            application/json:
              schema:
                type: object
                properties:
                  factors:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: integer
                        name:
                          type: string
                        coefficient:
                          type: number
                        unit:
                          type: string
                        category:
                          type: string
                        subcategory:
                          type: string
                        midcategory:
                          type: string
                        announcement_year:
                          type: integer
  /product_types/{product_type_id}/{product_id}/emissions:
    get:
      summary: Get all emissions under a product
      tags: [Emissions]
      security:
        - BearerAuth: []
      parameters:
        - name: product_type_id
          in: path
          required: true
          schema: { type: integer, minimum: 1 }
        - name: product_id
          in: path
          required: true
          schema: { type: integer, minimum: 1 }
      responses:
        "200":
          description: List of emissions
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    id:
                      type: integer
                    amount:
                      type: number
                      format: float
                    timestamp:
                      type: string
                      format: date-time
        "404":
          description: Product not found
    post:
      summary: Create a new emission under a product
      tags: [Emissions]
      security:     
        - BearerAuth: []
      parameters:
        - name: product_type_id
          in: path
          required: true
          schema: { type: integer, minimum: 1 }
        - name: product_id
          in: path
          required: true
          schema: { type: integer, minimum: 1 }
      requestBody:    
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                amount:
                  type: number
                  format: float
                  example: 12.34
                timestamp:
                  type: string
                  format: date-time
                  example: "2024-01-01T12:00:00Z"
      responses:
        "201":
          description: Emission created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: integer
                  amount:
                    type: number
                    format: float
                  timestamp:
                    type: string
                    format: date-time
  /product_types/{product_type_id}/{product_id}/emissions/{emission_id}:
    get:
      summary: Get an emission by ID
      tags: [Emissions]
      security:
        - BearerAuth: []
      parameters:
        - name: product_type_id
          in: path
          required: true
          schema: { type: integer, minimum: 1 }
        - name: product_id
          in: path
          required: true
          schema: { type: integer, minimum: 1 }
        - name: emission_id
          in: path
          required: true
          schema: { type: integer, minimum: 1 }     
      responses:
        "200":
          description: Emission details
          content:
            application/json:
              schema:   
                type: object
                properties:
                  id:
                    type: integer
                  amount:
                    type: number
                    format: float
                  timestamp:
                    type: string
                    format: date-time
        "404":
          description: Emission not found
    put:
      summary: Update an emission by ID
      tags: [Emissions]
      security:
        - BearerAuth: []        
      parameters:
        - name: product_type_id
          in: path
          required: true
          schema: { type: integer, minimum: 1 }
        - name: product_id
          in: path
          required: true
          schema: { type: integer, minimum: 1 }
        - name: emission_id
          in: path
          required: true
          schema: { type: integer, minimum: 1 }
      requestBody:      
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                amount:
                  type: number
                  format: float
                  example: 23.45
                timestamp:
                  type: string
                  format: date-time
                  example: "2024-02-01T12:00:00Z"
      responses:
        "200":
          description: Emission updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: integer     
                  amount:
                    type: number
                    format: float
                  timestamp:
                    type: string
                    format: date-time
        "400":
          description: Invalid input
        "401":
          description: Unauthorized
        "404":
          description: Emission not found
    delete:
      summary: Delete an emission by ID 
      tags: [Emissions]
      security:
        - BearerAuth: []
      parameters:     
        - name: product_type_id
          in: path
          required: true
          schema: { type: integer, minimum: 1 }  
        - name: product_id
          in: path
          required: true  
          schema: { type: integer, minimum: 1 }
        - name: emission_id
          in: path
          required: true        
          schema: { type: integer, minimum: 1 }
      responses:  
        "200":
          description: Emission deleted successfully
          content:
            application/json: 
              schema:
                type: object
                properties:
                  message:
                    type: string
        "401":
          description: Unauthorized
        "404":
          description: Emission not found
          

  