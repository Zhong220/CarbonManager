# backend/openapi.yaml
openapi: 3.0.3
info:
  title: CarbonManager On-Chain API
  version: 1.0.0
servers:
  - url: http://localhost:5001
components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
paths:
  /onchain/emissions/{emission_id}:
    post:
      summary: Create/refresh a pending on-chain job for an emission
      tags: [Blockchain]
      parameters:
        - in: path
          name: emission_id
          required: true
          schema: { type: string, minimum: 1 }
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }
                  emission_id: { type: integer }
                  status: { type: string, enum: [pending] }
                  payload: { type: object }
        "404":
          description: Emission not found
    get:
      summary: Get on-chain status for an emission
      tags: [Blockchain]
      parameters:
        - in: path
          name: emission_id
          required: true
          schema: { type: integer, minimum: 1 }
      responses:
        "200":
          description: Status record
          content:
            application/json:
              schema:
                type: object
                properties:
                  emission_id: { type: integer }
                  status: { type: string, enum: [pending,submitted,confirmed,failed] }
                  tx_hash: { type: string, nullable: true }
                  payload_json: { type: object }
                  error_msg: { type: string, nullable: true }
        "404":
          description: No on-chain record
  /onchain/callback:
    put:
      summary: Chain-service callback to update status & tx hash
      tags: [Blockchain]
      parameters:
        - in: header
          name: X-Chain-Secret
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              oneOf:
                - type: object
                  properties:
                    emission_id: { type: integer }
                    status: { type: string, enum: [submitted,confirmed,failed] }
                    tx_hash: { type: string, nullable: true }
                    error_msg: { type: string, nullable: true }
                - type: object
                  properties:
                    tx_hash: { type: string }
                    status: { type: string, enum: [submitted,confirmed,failed] }
                    error_msg: { type: string, nullable: true }
      responses:
        "200":
          description: Updated
        "401":
          description: Unauthorized
        "404":
          description: Record not found
  /auth/register:
    post:
      summary: Register a new user
      tags: [Authorization]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                account:
                  type: string
                  example: user@example.com
                password:
                  type: string
                  example: mysecret
                role:
                  type: string
                  example: shop
                user_name:
                  type: string
                  example: Alice
                organization_name:
                  type: string
                  example: Lee's Tea
      responses:
        "201":
          description: User registered successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  status_message:
                    type: string
                  access_token:
                    type: string
                  refresh_token:
                    type: string
                  account:
                    type: string
                  password:
                    type: string
                  user_name:
                    type: string
                  role:
                    type: string
                  organization_id:
                    type: string
        "400":
          description: Missing or invalid input
        "409":
          description: User already exists         
  /auth/login:
    post:
      summary: Login with account and password
      tags: [Authorization]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                account:
                  type: string
                  example: user@example.com
                password:
                  type: string
                  example: mysecret
      responses:
        "200":
          description: Login successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                  account:
                    type: string
                  access_token:
                    type: string
                  refresh_token:
                    type: string
                  role:
                    type: string
                  current_organization_id:
                    type: string
        "400":
          description: Invalid input
        "401":
          description: Invalid credentials
  /auth/me:
    get:
      summary: Get current logged-in user
      tags: [Authorization]
      security:
        - BearerAuth: []
      responses:
        "200":
          description: User profile
          content:
            application/json:
              schema:
                type: object
                properties:
                  user_id:
                    type: string
                    example: USR1
                  email_account:
                    type: string
                    example: user@example.com
                  user_name:
                    type: string
                    example: Alice
                  user_type:
                    type: string
                    enum: [shop, customer]
                  organization_id:
                    type: string
                    example: ORG4
        "401":
          description: Unauthorized
        "404":
          description: User not found
    put:
      summary: Update current logged-in user profile
      tags: [Authorization]
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                organization_name:
                  type: string
                  example: Lee's New Tea Shop
                user_type:
                  type: string
                  example: shop
      responses:
        "200":
          description: User profile updated successfully
        "400":
          description: Invalid input
        "401":
          description: Unauthorized
    delete:
      summary: Delete current logged-in user
      tags: [Authorization]
      security:
        - BearerAuth: []
      responses:
        "200":
          description: User deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  status_message:
                    type: string
                    example: User deleted successfully
        "401":
          description: Unauthorized           
  /product_types:
    get:
      summary: Get all available product types from this organization 
      tags: [Product types]
      security:
        - BearerAuth: []
      responses:
        "200":
          description: List of product types
          content:
            application/json:
              schema:
                type: object
                properties:
                  product_types:
                    type: array
                    items:
                      type: object
                      properties:
                        product_type_id:
                          type: string
                          example: PT1
                        product_type_name:
                          type: string
                          example: Green Tea 2025
        "500":
          description: Server error
    post:
      summary: Create a new product type
      tags: [Product types]
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                product_type_name:
                  type: string
                  example: Green Tea 2025 
      responses:
        "201":
          description: Product type created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  product_type_id:
                    type: string
                    example: PT1
                  product_type_name:
                    type: string
                    example: Green Tea 2025
                  organization_id: 
                    type: string
                    example: ORG4
                  organization_name:
                    type: string
                    example: Lee's Tea
                  created_at: 
                    type: string
                    example: 2024-01-01T12:00:00Z
                  updated_at: 
                    type: string
                    example: 2024-01-01T12:00:00Z
                  order_id:
                    type: int
                    example: 1

        "400":
          description: Invalid input   
        "401":
          description: Unauthorized
        "409":
          description: Product type already exists
  /product_types/{product_type_id}:
      get:
        summary: Get a product type by ID
        tags: [Product types]
        security:
          - BearerAuth: []
        parameters:
          - in: path
            name: product_type_id
            required: true
            schema: { type: string, minimum: 1 }
        responses:
          "200":
            description: Product type details
            content:
              application/json:
                schema:
                  type: object
                  properties:
                    product_type_id:
                      type: string
                      example: PT1
                    product_type_name:
                      type: string
                      example: Green Tea 2025
                    organization_id:
                      type: string
                      example: ORG4
                    organization_name:
                      type: string
                      example: Lee's Tea
                    created_at: 
                      type: string
                      example: 2024-01-01T12:00:00Z
                    updated_at:
                      type: string
                      example: 2024-01-01T12:00:00Z
          "404":
            description: Product type not found
      put:
        summary: Update a product type by ID
        tags: [Product types]
        security:
          - BearerAuth: []        
        parameters:
          - in: path
            name: product_type_id
            required: true
            schema: { type: string, minimum: 1 }
        requestBody:      
          required: true
          content:
            application/json:
              schema:
                type: object
                properties:
                  name:
                    type: string
                    example: Updates Green Tea 2025
        responses:
          "200":
            description: Product type updated successfully
          "400":
            description: Invalid input
          "401":
            description: Unauthorized
          "404":
            description: Product type not found
      delete:
        summary: Delete a product type by ID
        tags: [Product types]
        security:
          - BearerAuth: []
        parameters:
          - in: path
            name: product_type_id
            required: true        
            schema: { type: string, minimum: 1 }
        responses:
          "200":
            description: Product type deleted successfully
            content:
              application/json:
                schema:
                  type: object
                  properties:
                    status:
                      type: string
                    product_type_id:
                      type: string
                    product_type_name:
                      type: string
                    order_id:
                      type: integer
                    
          "401":
            description: Unauthorized     
          "404":
            description: Product type not found
  /product_types/{product_type_id}/products:
    get:
      summary: Get all products under a product type
      tags: [Products]
      security:
        - BearerAuth: []
      parameters:
        - name: product_type_id
          in: path
          required: true
          schema: { type: string, minimum: 1 }
      responses:
        "200":
          description: List of products
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    product_id:
                      type: string
                    product_name:
                      type: string
    post:
      summary: Create a new product under a product type
      tags: [Products]
      security:
        - BearerAuth: []
      parameters:
        - name: product_type_id
          in: path
          required: true
          schema: { type: string, minimum: 1 }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                  example: Batch #12345
      responses:
        "201":
          description: Product created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  product_id:
                    type: string
                    example: PRD1
                  product_name:
                    type: string
                    example: Green Tea Batch 
        "400":
          description: Invalid input
        "401":
          description: Unauthorized
        "404":
          description: Product type not found
        "409":
          description: Product already exists
  /products/{product_id}:
    get:
      summary: Get a product by ID
      tags: [Products]
      security:
        - BearerAuth: []
      parameters:
        - name: product_type_id
          in: path
          required: true
          schema: { type: string, minimum: 1 }
        - name: product_id
          in: path
          required: true
          schema: { type: string, minimum: 1 }     
      responses:
        "200":
          description: Product details
          content:
            application/json:
              schema:   
                type: object
                properties:
                  product_id:
                    type: string
                    example: PD1
                  product_name:
                    type: string
                    example: Green Tea Batch
                  serial_number:
                    type: string
                  total_emission:
                    type: number
                    format: float
                    example: 123.45
                  created_at:
                    type: string
                    example: 2024-01-01T12:00:00Z
                  ended_at:
                    type: string
                    example: 2024-01-31T12:00:00Z
                  code:
                    type: string
        "404":
          description: Product not found
    put:    
      summary: Update a product by ID
      tags: [Products]
      security:
        - BearerAuth: []        
      parameters:
        - name: product_type_id
          in: path
          required: true
          schema: { type: string, minimum: 1 }
        - name: product_id
          in: path
          required: true
          schema: { type: string, minimum: 1 }
      requestBody:      
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                new_product_name:
                  type: string
                  example: Updated Batch 
      responses:
        "200":
          description: Product updated successfully
        "400":
          description: Invalid input
        "401":
          description: Unauthorized
        "404":
          description: Product not found
    delete:
      summary: Delete a product by ID
      tags: [Products]
      security:
        - BearerAuth: []
      parameters:     
        - name: product_type_id  
          in: path
          required: true
          schema: { type: string, minimum: 1 }  
        - name: product_id
          in: path
          required: true        
          schema: { type: string, minimum: 1 }
      responses:
        "200":
          description: Product deleted successfully
          content:
            application/json: 
              schema:
                type: object
                properties:
                  status_message:
                    type: string
        "401":
          description: Unauthorized
        "404":
          description: Product not found 
  /products/{product_id}/steps/{stage_id}:
    get:
      summary: Get all steps order under a stage of a product
      tags: [Product Steps]
      security:
        - BearerAuth: []
      parameters:
        - name: product_id
          in: path
          required: true
          schema: { type: string, minimum: 1 }
        - name: stage_id
          in: path
          required: true
          schema: { type: string }   
      responses:
        "200":
          description: List of stage orders
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    step_id:
                      type: string
                    step_name:
                      type: string
                    tag_id:
                      type: string
                    sort_order:
                      type: integer
        "404":
          description: Product not found
  /products/{product_id}/steps:
    post:
      summary: Create a new step order under a stage of a product
      tags: [Product Steps]
      security:
        - BearerAuth: []
      parameters:
        - name: product_id  
          in: path
          required: true
          schema: { type: string, minimum: 1 }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                step_id:
                  type: string
                  example: STP1
                step_name: 
                  type: string
                  example: 原料採購
                tag_id:
                  type: string
                  example: TAG1
                sort_order:
                  type: integer
                  example: 1
                created_at:
                  type: string
                  example: 2024-01-01T12:00:00Z
      responses:
        "201":
          description: Stage order created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  step_id:
                    type: string
                  order:
                    type: integer
                  tag_id:
                    type: string
                  stage_id:
                    type: string
        "400":
          description: Invalid input
        "401":
          description: Unauthorized 
  /products/{product_id}/emissions:
    get:
      summary: Get all emissions under a product
      tags: [Product Emissions]
      security:
        - BearerAuth: []
      parameters:
        - name: product_type_id
          in: path
          required: true
          schema: { type: string, minimum: 1 }
        - name: product_id
          in: path
          required: true
          schema: { type: string, minimum: 1 }
      responses:
        "200":
          description: List of emissions
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    emission_id:
                      type: string
                    amount:
                      type: number
                      format: float
                    timestamp:
                      type: string
                      format: date-time
        "404":
          description: Product not found
    post:
      summary: Create a new emission under a product
      tags: [Product Emissions]
      security:     
        - BearerAuth: []
      parameters:
        - name: product_type_id
          in: path
          required: true
          schema: { type: string, minimum: 1 }
        - name: product_id
          in: path
          required: true
          schema: { type: string, minimum: 1 }
      requestBody:    
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                  example: 原料採購-瓶裝水
                step_id:
                  type: string
                  example: STP1
                tag_id:
                  type: string
                  example: TAG1
                stage_id:
                  type: string 
                  example: raw
                factor_id:
                  type: integer
                  example: 1
                material:
                  type: string
                  example: 瓶裝水(2000ml，PET包裝)
                unit:
                  type: string
                  example: 瓶
                quantity:
                  type: number
                  format: float
                  example: 2
      responses:
        "201":
          description: Emission created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  emission_id:
                    type: string
                  status_message:
                    type: string
  /products/{product_id}/emissions/summary:
    get:
      summary: Get emissions summary for a product
      tags: [Product Emissions]
      security:
        - BearerAuth: []
      parameters:
        - name: product_type_id
          in: path
          required: true
          schema: { type: string, minimum: 1 }
        - name: product_id
          in: path
          required: true
          schema: { type: string, minimum: 1 }
      responses:
        "200":
          description: Emissions summary
          content:
            application/json:
              schema:
                type: object
                properties:
                  total_emissions:
                    type: number
                    format: float
                  average_emissions:
                    type: number
                    format: float
                  emission_count:
                    type: integer
        "404":
          description: Product not found
  /emissions:
    get:
      summary: Get all emissions from one organization, across all product types and products
      tags: [Emissions]
      security:
        - BearerAuth: []
      responses:
        "200":
          description: List of all emissions
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    emission_id:
                      type: string
                    emission_name:
                      type: string
                    stage_id:
                      type: string
                    step_id:
                      type: string
                    tag_id:
                      type: string
                    factor_id:
                      type: integer
                    quantity:
                      type: number
                      format: float
                    emission_amount:
                      type: number
                      format: float
                    created_at:
                      type: string
                    created_by:
                      type: string
  /emissions/{emission_id}:
    get:
      summary: Get an emission by ID
      tags: [Emissions]
      security:
        - BearerAuth: []
      parameters:
        - name: emission_id
          in: path
          required: true
          schema: { type: string, minimum: 1 }     
      responses:
        "200":
          description: Emission details
          content:
            application/json:
              schema:   
                type: object
                properties:
                  emission_id:
                    type: string
                  emission_name:
                    type: string
                  stage_id:
                    type: string
                  step_id:
                    type: string
                  tag_id:
                    type: string
                  factor_id:
                    type: integer
                  quantity:
                    type: number
                    format: float
                  emission_amount:
                    type: number
                    format: float
                  unit_target_amount:
                    type: number
                  created_at:
                    type: string
                  created_by:
                    type: string
        "404":
          description: Emission not found
    put:
      summary: Update an emission by ID
      tags: [Emissions]
      security:
        - BearerAuth: []        
      parameters:
        - name: emission_id
          in: path
          required: true
          schema: { type: string, minimum: 1 }
      requestBody:      
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                new amount:
                  type: number
                  format: float
                  example: 23.45
      responses:
        "200":
          description: Emission updated successfully
        "400":
          description: Invalid input
        "401":
          description: Unauthorized
        "404":
          description: Emission not found
    delete:
      summary: Delete an emission by ID 
      tags: [Emissions]
      security:
        - BearerAuth: []
      parameters:     
        - name: emission_id
          in: path
          required: true        
          schema: { type: string, minimum: 1 }
      responses:  
        "200":
          description: Emission deleted successfully
          content:
            application/json: 
              schema:
                type: object
                properties:
                  status_message:
                    type: string
        "401":
          description: Unauthorized
        "404":
          description: Emission not found
  /factors:
    get:
      summary: Retrieve emission factors
      description: 
        Returns a list of emission factors. Supports search and filtering.
      tags:
        - Factors
      security:
        - BearerAuth: []
      parameters:
        - in: query
          name: q
          schema:
            type: string
          required: false
          description: Free-text keyword to search factor names, categories, or subcategories.
        - in: query
          name: category
          schema:
            type: string
          required: false
          description: Filter by main category (e.g., 能資源, 包裝資材).
        - in: query
          name: midcategory
          schema:
            type: string
          required: false
          description: Filter by middle category.
        - in: query
          name: subcategory
          schema:
            type: string
          required: false
          description: Filter by subcategory.
        - in: query
          name: unit
          schema:
            type: string
          required: false
          description: Filter by unit type (e.g., 立方公尺(m3), 平方公尺(m2)).
        - in: query
          name: limit
          schema:
            type: integer
            default: 20
          required: false
          description: Number of results to return.
        - in: query
          name: offset
          schema:
            type: integer
            default: 0
          required: false
          description: Number of items to skip before starting to return results.
      responses:
        "200":
          description: Successful operation
          content:
            application/json:
              schema:
                type: object
                properties:
                  factors:
                    type: array
                    items:
                      type: object
                      properties:
                        factor_id:
                          type: string
                        factor_name:
                          type: string
                        coefficient:
                          type: number
                        unit:
                          type: string
                        category:
                          type: string
                        subcategory:
                          type: string
                        midcategory:
                          type: string
                        announcement_year:
                          type: integer
  /report/{product_id}:
    get:
      summary: 
        Download Excel report for a product
      parameters:
        - in: path
          name: product_id
          required: true
          schema:
            type: string
      security:
        - BearerAuth: []
      responses:
        200:
            description: Excel file
        400:
          description: Bad request
        401:
          description: Unauthorized