# backend/openapi.yaml
# YAML file defining the OpenAPI specification for the on-chain API, used by Swagger UI at /docs
openapi: 3.0.3
info:
  title: CarbonManager On-Chain API
  version: 1.0.0
servers:
  - url: http://localhost:5001
components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
paths:
  /onchain/emissions/{emission_id}:
    post:
      summary: Create/refresh a pending on-chain job for an emission
      parameters:
        - in: path
          name: emission_id
          required: true
          schema: { type: integer, minimum: 1 }
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              additionalProperties: true
            example: {}
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }
                  emission_id: { type: integer }
                  status: { type: string, enum: [pending] }
                  payload: { type: object }
        "404":
          description: Emission not found
    get:
      summary: Get on-chain status for an emission
      parameters:
        - in: path
          name: emission_id
          required: true
          schema: { type: integer, minimum: 1 }
      responses:
        "200":
          description: Status record
          content:
            application/json:
              schema:
                type: object
                properties:
                  emission_id: { type: integer }
                  status: { type: string, enum: [pending,submitted,confirmed,failed] }
                  tx_hash: { type: string, nullable: true }
                  payload_json: { type: object }
                  error_msg: { type: string, nullable: true }
        "404":
          description: No on-chain record
  /onchain/callback:
    put:
      summary: Chain-service callback to update status & tx hash
      parameters:
        - in: header
          name: X-Chain-Secret
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              oneOf:
                - type: object
                  properties:
                    emission_id: { type: integer }
                    status: { type: string, enum: [submitted,confirmed,failed] }
                    tx_hash: { type: string, nullable: true }
                    error_msg: { type: string, nullable: true }
                - type: object
                  properties:
                    tx_hash: { type: string }
                    status: { type: string, enum: [submitted,confirmed,failed] }
                    error_msg: { type: string, nullable: true }
      responses:
        "200":
          description: Updated
        "401":
          description: Unauthorized
        "404":
          description: Record not found
  /auth/register:
    post:
      summary: Register a new user
      tags: [Auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                account:
                  type: string
                  example: user@example.com
                password:
                  type: string
                  example: mysecret
                user_name:
                  type: string
                  example: Alice
      responses:
        "201":
          description: User registered successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  access_token:
                    type: string
                  refresh_token:
                    type: string
        "400":
          description: Missing or invalid input
        "409":
          description: User already exists
  /auth/login:
    post:
      summary: Login with account and password
      tags: [Auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                account:
                  type: string
                  example: user@example.com
                password:
                  type: string
                  example: mysecret
      responses:
        "200":
          description: Login successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  access_token:
                    type: string
                  refresh_token:
                    type: string
        "400":
          description: Invalid input
        "401":
          description: Invalid credentials
  /auth/me:
    get:
      summary: Get current logged-in user
      tags: [Auth]
      security:
        - BearerAuth: []
      responses:
        "200":
          description: User profile
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: integer
                  email_account:
                    type: string
                  name:
                    type: string
                  user_type:
                    type: string
                    enum: [shop, customer]
                  organization_id:
                    type: integer
        "401":
          description: Unauthorized